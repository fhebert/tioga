#!/usr/bin/env ruby

# This file is copyright 2007 by Vincent Fourmond
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
  
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# The goal of this file is to establish a correspondance between
# PNG images used inside the documentation and figures inside the
# files in the sample directory.

# This script creates an images/ directory which should be copied to the
# directory generated by rdoc, so that the images display properly.

# The correspondance file:figure -> target.

IMAGES = {
  "samples/plots/plots.rb:Blues" => "blues",
}

FIGURES = {}

def get_figure_index(file, figure)
  if FIGURES.key?(file)
    return FIGURES[file][figure]
  else
    f = IO.popen("tioga #{file} -l")
    h = {}
    for l in f
      if l =~ /(\d+)\s+(.*)/
        h[$2] = $1
      end
    end
    f.close
    FIGURES[file] = h
    return get_figure_index(file, figure)
  end
end

density = 96

for s,t in IMAGES
  puts "Creating image #{t}.png from #{s}"
  s =~ /(.*):(.*)/
  file = $1
  figure = $2
  idx = get_figure_index(file, figure)
  `tioga #{file} -m #{idx}` =~ /\s*(?:\d+\s+)?(.*\.pdf)/
  pdf = $1
  system "convert -density #{density} #{pdf} -trim images/#{t}.png"
end

